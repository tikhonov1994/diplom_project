version: '2.2'

services:
  elk-elastic:
    image: elasticsearch:8.6.2
    container_name: elk-elastic
    environment:
      - "xpack.security.enabled=false"
      - "discovery.type=single-node"
    ports:
      - "9200:9200"
    volumes:
      - /esdata:/tmp/elasticsearch/data
    healthcheck:
      test: curl --fail http://elk-elastic:9200/_cat/indices?v || exit 1
      interval: 5s
      retries: 3
    networks:
      - application_network

  logstash:
    image: logstash:7.10.1
    container_name: logstash
    environment:
      XPACK_MONITORING_ENABLED: "false"
      ES_HOST: "elk-elastic:9200"
    expose:
      - "18010/udp"
      - "5045/udp"
    volumes:
      - ./logstash.conf:/config/logstash.conf:ro
      - nginx_logs:/var/log/nginx/:ro
    depends_on:
      elk-elastic:
        condition: service_healthy
    command: logstash -f /config/logstash.conf
    networks:
      - application_network

  kibana:
    image: kibana:7.17.13
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: "http://elk-elastic:9200"
    depends_on:
      elk-elastic:
        condition: service_healthy
    networks:
      - application_network
